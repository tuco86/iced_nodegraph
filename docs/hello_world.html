<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iced_nodegraph - Interactive WebGPU Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Fira Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e2e;
            color: #cdd6f4;
            overflow: hidden;
            height: 100vh;
        }
        
        /* Canvas container - CRITICAL: pointer-events: none allows events to pass through */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Canvas receives events */
        canvas {
            display: block !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: #1e1e2e !important;
            pointer-events: auto !important;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #313244;
            border-top-color: #89b4fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #error {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f38ba8;
            color: #1e1e2e;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        #error h2 {
            margin-bottom: 1rem;
        }
        
        #error pre {
            background: #11111b;
            color: #f38ba8;
            padding: 1rem;
            border-radius: 8px;
            overflow: auto;
            max-height: 200px;
            font-size: 0.875rem;
        }
        
        #info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #45475a;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        #info h3 {
            color: #89b4fa;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        #info ul {
            list-style: none;
            font-size: 0.75rem;
            line-height: 1.6;
        }
        
        #info li:before {
            content: "‚ñ∏ ";
            color: #89b4fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: #89b4fa;">Loading WebGPU demo...</p>
    </div>
    
    <div id="error">
        <h2>‚ùå Failed to Load</h2>
        <p id="error-message"></p>
        <pre id="error-details"></pre>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="info">
        <h3>üéØ Controls</h3>
        <ul>
            <li>Drag nodes to move</li>
            <li>Drag from pins to connect</li>
            <li>Click edges to disconnect</li>
            <li>Scroll to zoom</li>
            <li>Middle-drag to pan</li>
            <li>Ctrl+K for command palette</li>
        </ul>
    </div>

    <script type="module">
        let initialized = false;
        
        async function init() {
            if (initialized) {
                console.log('‚ö†Ô∏è Already initialized, skipping...');
                return;
            }
            
            try {
                console.log('üîÑ Loading WASM module...');
                
                // Import the WASM module
                const wasm = await import('./pkg/iced_nodegraph.js');
                
                console.log('üîÑ Initializing WASM...');
                
                // Initialize WASM (calls wasm_init automatically)
                await wasm.default();
                
                console.log('‚úÖ WASM module loaded and initialized');
                
                // Hide loading screen
                document.getElementById('loading').style.display = 'none';
                
                console.log('üöÄ Calling wasm.run()...');
                
                // Mark as initialized before calling run to prevent multiple calls
                initialized = true;
                
                // Run the Iced application (this spawns the event loop and returns immediately)
                wasm.run();
                
                console.log('‚úÖ Event loop started');
                
                // Wait a bit for Iced to create the canvas, then make it focusable
                setTimeout(() => {
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.setAttribute('tabindex', '0');
                        canvas.focus();
                        console.log('‚úÖ Canvas is now focusable');
                    } else {
                        console.warn('‚ö†Ô∏è Canvas not found after timeout');
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = 
                    'Failed to load the WASM module. Make sure you have built it with wasm-pack.';
                document.getElementById('error-details').textContent = error.toString();
            }
        }
        
        // Start initialization
        init();
    </script>
</body>
</html>
